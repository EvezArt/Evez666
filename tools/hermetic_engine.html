<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hermetic Engine Monitor</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      background: #0c0f14;
      color: #e6ecf2;
    }
    body {
      margin: 0;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .banner {
      background: #3a1111;
      border: 1px solid #ff6f6f;
      color: #ffd4d4;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 600;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    .panel {
      background: #141a22;
      border: 1px solid #243244;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    }
    .panel h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }
    label {
      display: block;
      font-size: 0.85rem;
      color: #b4c0d4;
      margin-bottom: 6px;
    }
    input, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #2f3b52;
      background: #0f131a;
      color: #e6ecf2;
    }
    button {
      background: #2d6cdf;
      color: #f4f6fb;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button.secondary {
      background: #2a3648;
    }
    button.danger {
      background: #a64040;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .metric {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
      background: #10151f;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #1d2736;
    }
    .metric span.value {
      font-size: 1.2rem;
      font-weight: 700;
    }
    .pill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      background: #1f2836;
      color: #9eb2d3;
    }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      background: #0f141e;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #263245;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Hermetic Engine Console</h1>
    <div class="banner">
      Personal use only. Do not attempt manipulation, coercion, or influence over others.
    </div>
  </header>

  <section class="grid">
    <div class="panel">
      <h2>Identity Seed (In-Memory)</h2>
      <label for="seedInput">IDENTITY_SEED</label>
      <input id="seedInput" type="text" placeholder="Enter seed (stored only in memory)" />
      <div class="row" style="margin-top: 12px;">
        <button id="applySeed">Apply Seed</button>
        <button id="clearSeed" class="secondary">Clear Seed</button>
      </div>
      <p style="font-size: 0.8rem; color: #91a0b8;">
        The seed never leaves this page. Refreshing the page clears it.
      </p>
      <div class="pill" id="seedStatus">Seed: not set</div>
    </div>

    <div class="panel">
      <h2>EEG Simulation</h2>
      <div class="row">
        <button id="startBtn">START</button>
        <button id="stopBtn" class="danger" disabled>STOP</button>
        <button id="simulateBtn" class="secondary">SIMULATE</button>
        <button id="exportBtn" class="secondary">EXPORT</button>
      </div>
      <p style="font-size: 0.8rem; color: #91a0b8;">
        Deterministic alpha/beta/theta series driven by the current IDENTITY_SEED.
      </p>
      <div class="row" id="metrics"></div>
    </div>

    <div class="panel">
      <h2>phi_proxy Transparency</h2>
      <p style="font-size: 0.85rem; color: #9eb0c8;">
        phi_proxy = (beta + theta) / (alpha + 1)
      </p>
      <div class="metric">
        <span>phi_proxy</span>
        <span class="value" id="phiValue">0.00</span>
      </div>
      <pre id="phiLog">Awaiting simulation...</pre>
    </div>

    <div class="panel">
      <h2>Legion Status (Read-Only)</h2>
      <label for="apiBase">API Base URL</label>
      <input id="apiBase" type="text" placeholder="http://localhost:8000" />
      <label for="apiKey" style="margin-top: 10px;">API Key (optional)</label>
      <input id="apiKey" type="password" placeholder="X-API-Key" />
      <div class="row" style="margin-top: 12px;">
        <button id="fetchLegion">Fetch /legion-status</button>
      </div>
      <pre id="legionOutput">No data fetched.</pre>
    </div>
  </section>

  <script>
    const seedInput = document.getElementById("seedInput");
    const applySeed = document.getElementById("applySeed");
    const clearSeed = document.getElementById("clearSeed");
    const seedStatus = document.getElementById("seedStatus");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const simulateBtn = document.getElementById("simulateBtn");
    const exportBtn = document.getElementById("exportBtn");
    const metrics = document.getElementById("metrics");
    const phiValue = document.getElementById("phiValue");
    const phiLog = document.getElementById("phiLog");
    const apiBase = document.getElementById("apiBase");
    const apiKey = document.getElementById("apiKey");
    const fetchLegion = document.getElementById("fetchLegion");
    const legionOutput = document.getElementById("legionOutput");

    let identitySeed = "";
    let tick = 0;
    let intervalId = null;
    const history = [];

    const hashSeed = (value) => {
      let hash = 2166136261;
      for (let i = 0; i < value.length; i += 1) {
        hash ^= value.charCodeAt(i);
        hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
      }
      return hash >>> 0;
    };

    const mulberry32 = (seed) => {
      let a = seed;
      return () => {
        a |= 0;
        a = (a + 0x6d2b79f5) | 0;
        let t = Math.imul(a ^ (a >>> 15), 1 | a);
        t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    };

    const getRng = () => {
      const seed = identitySeed ? hashSeed(identitySeed) : 1337;
      return mulberry32(seed + tick * 9973);
    };

    const simulateTick = () => {
      const rng = getRng();
      const base = tick / 10;
      const alpha = 0.6 + 0.3 * Math.sin(base) + rng() * 0.1;
      const beta = 0.4 + 0.4 * Math.cos(base / 1.7) + rng() * 0.2;
      const theta = 0.3 + 0.2 * Math.sin(base / 2.1) + rng() * 0.15;
      const phi = (beta + theta) / (alpha + 1);

      const entry = {
        tick,
        alpha: Number(alpha.toFixed(4)),
        beta: Number(beta.toFixed(4)),
        theta: Number(theta.toFixed(4)),
        phi_proxy: Number(phi.toFixed(4)),
        seed: identitySeed || "<unset>",
        timestamp: new Date().toISOString(),
      };
      history.push(entry);
      tick += 1;
      renderMetrics(entry);
    };

    const renderMetrics = (entry) => {
      metrics.innerHTML = "";
      ["alpha", "beta", "theta"].forEach((key) => {
        const card = document.createElement("div");
        card.className = "metric";
        card.innerHTML = `<span>${key.toUpperCase()}</span><span class="value">${entry[key]}</span>`;
        metrics.appendChild(card);
      });
      phiValue.textContent = entry.phi_proxy.toFixed(2);
      phiLog.textContent = JSON.stringify({
        formula: "(beta + theta) / (alpha + 1)",
        beta: entry.beta,
        theta: entry.theta,
        alpha: entry.alpha,
        phi_proxy: entry.phi_proxy,
      }, null, 2);
    };

    const setSeedStatus = () => {
      seedStatus.textContent = identitySeed ? `Seed: ${identitySeed}` : "Seed: not set";
    };

    applySeed.addEventListener("click", () => {
      identitySeed = seedInput.value.trim();
      tick = 0;
      history.length = 0;
      setSeedStatus();
    });

    clearSeed.addEventListener("click", () => {
      identitySeed = "";
      seedInput.value = "";
      tick = 0;
      history.length = 0;
      setSeedStatus();
    });

    startBtn.addEventListener("click", () => {
      if (intervalId) return;
      simulateTick();
      intervalId = setInterval(simulateTick, 1200);
      startBtn.disabled = true;
      stopBtn.disabled = false;
    });

    stopBtn.addEventListener("click", () => {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });

    simulateBtn.addEventListener("click", () => {
      simulateTick();
    });

    exportBtn.addEventListener("click", () => {
      const payload = {
        identity_seed: identitySeed || null,
        generated_at: new Date().toISOString(),
        history,
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "hermetic_engine_export.json";
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    });

    fetchLegion.addEventListener("click", async () => {
      const base = apiBase.value.trim();
      if (!base) {
        legionOutput.textContent = "Set an API base URL first.";
        return;
      }
      const headers = {};
      if (apiKey.value.trim()) {
        headers["X-API-Key"] = apiKey.value.trim();
      }
      try {
        const response = await fetch(`${base.replace(/\/$/, "")}/legion-status`, { headers });
        const data = await response.json();
        legionOutput.textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        legionOutput.textContent = `Error: ${error.message}`;
      }
    });

    setSeedStatus();
  </script>
</body>
</html>
