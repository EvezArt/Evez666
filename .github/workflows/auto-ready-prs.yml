name: Auto-Ready Draft PRs

on:
  pull_request:
    types: [opened, synchronize]
  check_suite:
    types: [completed]

permissions:
  pull-requests: write
  checks: read

jobs:
  check-and-ready:
    if: github.event.pull_request.draft == true || (github.event.check_suite && github.event.check_suite.pull_requests[0].draft == true)
    runs-on: ubuntu-latest
    steps:
      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.check_suite.pull_requests[0].number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Wait for CI checks to complete
        run: sleep 30
      
      - name: Check CI status
        id: ci-status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get all check runs for the PR
          CHECKS=$(gh api \
            repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }}/commits/$(gh api repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }} --jq '.head.sha')/check-runs \
            --jq '.check_runs[] | select(.status == "completed") | .conclusion')
          
          # Count failures (anything other than success or skipped)
          FAILURES=$(echo "$CHECKS" | grep -v -E "^(success|skipped|neutral)$" | wc -l || echo 0)
          
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT
          echo "CI check failures: $FAILURES"
      
      - name: Mark ready if CI passed
        if: steps.ci-status.outputs.failures == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr ready ${{ steps.pr-number.outputs.number }} --repo ${{ github.repository }}
          echo "âœ… PR #${{ steps.pr-number.outputs.number }} marked as ready for review"
