name: Daily repository report

# This workflow fetches all repositories for the owner EvezArt and generates JSON and CSV reports.
# To access private repositories, add a REPORT_TOKEN secret under Settings > Secrets > Actions.
# REPORT_TOKEN should be a Personal Access Token (PAT) with 'repo' scope.
# For public repositories only, the workflow will use the default GITHUB_TOKEN.

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Fetch repositories and generate reports
        env:
          # Use REPORT_TOKEN if available (for private repos), otherwise fall back to GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.REPORT_TOKEN || github.token }}
          OWNER: EvezArt
        run: |
          echo "Fetching repositories for owner: $OWNER"
          
          # Initialize variables for pagination
          page=1
          per_page=100
          all_repos="[]"
          
          # Fetch all repositories with pagination
          while true; do
            echo "Fetching page $page..."
            
            # Make API request
            response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/$OWNER/repos?per_page=$per_page&page=$page&type=all&sort=updated")
            
            # Check if response is empty array
            repo_count=$(echo "$response" | jq '. | length')
            
            if [ "$repo_count" -eq 0 ]; then
              echo "No more repositories found."
              break
            fi
            
            echo "Found $repo_count repositories on page $page"
            
            # Append to all_repos
            all_repos=$(echo "$all_repos" "$response" | jq -s 'add')
            
            # If we got fewer results than per_page, we're done
            if [ "$repo_count" -lt "$per_page" ]; then
              break
            fi
            
            page=$((page + 1))
          done
          
          total_count=$(echo "$all_repos" | jq '. | length')
          echo "Total repositories fetched: $total_count"
          
          # Generate JSON report
          echo "$all_repos" | jq '[.[] | {
            name: .name,
            full_name: .full_name,
            private: .private,
            description: .description,
            url: .html_url,
            language: .language,
            stars: .stargazers_count,
            forks: .forks_count,
            open_issues: .open_issues_count,
            created_at: .created_at,
            updated_at: .updated_at,
            size: .size
          }]' > repo-report.json
          
          echo "Generated JSON report: repo-report.json"
          
          # Generate CSV report
          echo "name,full_name,private,description,url,language,stars,forks,open_issues,created_at,updated_at,size" > repo-report.csv
          echo "$all_repos" | jq -r '.[] | [
            .name,
            .full_name,
            .private,
            (.description // ""),
            .html_url,
            (.language // ""),
            .stargazers_count,
            .forks_count,
            .open_issues_count,
            .created_at,
            .updated_at,
            .size
          ] | @csv' >> repo-report.csv
          
          echo "Generated CSV report: repo-report.csv"
          
          # Display summary
          echo "Report Summary:"
          echo "==============="
          echo "$all_repos" | jq -r '
            "Total repositories: " + (. | length | tostring),
            "Private repositories: " + ([.[] | select(.private == true)] | length | tostring),
            "Public repositories: " + ([.[] | select(.private == false)] | length | tostring)
          '
      
      - name: Upload JSON report
        uses: actions/upload-artifact@v4
        with:
          name: repo-report-json
          path: repo-report.json
          retention-days: 30
      
      - name: Upload CSV report
        uses: actions/upload-artifact@v4
        with:
          name: repo-report-csv
          path: repo-report.csv
          retention-days: 30
