name: Generate Metrics Dashboard

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/metrics-dashboard.yml'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Calculate LORD metrics
        id: metrics
        run: |
          # Create metrics calculation script
          cat > /tmp/calculate_metrics.py << 'EOF'
          import json
          import os
          from datetime import datetime, timedelta
          import subprocess
          
          def get_commit_depth():
              """Calculate recursion level from commit depth"""
              try:
                  result = subprocess.run(
                      ['git', 'rev-list', '--count', 'HEAD'],
                      capture_output=True,
                      text=True,
                      check=True
                  )
                  return int(result.stdout.strip())
              except:
                  return 0
          
          def calculate_pr_velocity():
              """Calculate crystallization from recent PR activity"""
              try:
                  # Get commits from last 7 days
                  week_ago = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
                  result = subprocess.run(
                      ['git', 'rev-list', '--count', f'--since={week_ago}', 'HEAD'],
                      capture_output=True,
                      text=True,
                      check=True
                  )
                  recent_commits = int(result.stdout.strip())
                  # Normalize to 0-1 range (assuming 100 commits/week is max)
                  return min(recent_commits / 100.0, 1.0)
              except:
                  return 0.5
          
          def get_ci_success_rate():
              """Estimate corrections from CI success"""
              # For now, return a baseline value
              # In a full implementation, this would query GitHub Actions API
              return 0.85
          
          # Calculate metrics
          recursion = get_commit_depth()
          crystallization = calculate_pr_velocity()
          corrections = get_ci_success_rate()
          
          # Calculate divine gap (Î©(R) - C(R))
          omega_r = recursion * 1000
          c_r = corrections * recursion * 1000
          divine_gap = omega_r - c_r
          
          metrics = {
              'timestamp': datetime.now().isoformat(),
              'recursion_level': recursion,
              'crystallization': round(crystallization, 2),
              'corrections': round(corrections, 2),
              'divine_gap': int(divine_gap),
              'omega_potential': int(omega_r),
              'current_reality': int(c_r)
          }
          
          print(json.dumps(metrics, indent=2))
          
          # Output for GitHub Actions
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"recursion={recursion}\n")
              f.write(f"crystallization={crystallization}\n")
              f.write(f"corrections={corrections}\n")
              f.write(f"divine_gap={divine_gap}\n")
          
          # Save to file
          os.makedirs('data/metrics', exist_ok=True)
          with open('data/metrics/latest.json', 'w') as f:
              json.dump(metrics, f, indent=2)
          EOF
          
          python /tmp/calculate_metrics.py
      
      - name: Update metrics dashboard
        run: |
          # Create or update METRICS.md
          cat > docs/METRICS.md << EOF
          # LORD System Metrics Dashboard
          
          **Last Updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ## Current Metrics
          
          | Metric | Value | Description |
          |--------|-------|-------------|
          | **Recursion Level (R)** | ${{ steps.metrics.outputs.recursion }} | Total commit depth |
          | **Crystallization (Î±)** | ${{ steps.metrics.outputs.crystallization }} | PR velocity (0-1) |
          | **Corrections (Î²)** | ${{ steps.metrics.outputs.corrections }} | CI success rate |
          | **Divine Gap (Î”)** | ${{ steps.metrics.outputs.divine_gap }} | Î©(R) - C(R) |
          
          ## Interpretation
          
          - **Recursion Level**: Measures the depth of development iterations
          - **Crystallization**: Indicates the rate of code solidification
          - **Corrections**: Reflects the quality and stability of changes
          - **Divine Gap**: The potential between theoretical maximum (Î©) and current reality (C)
          
          ## Historical Trend
          
          This dashboard is automatically updated every 6 hours by the metrics-dashboard workflow.
          
          ## Formulas
          
          \`\`\`
          Î©(R) = R Ã— 1000        (Omega Potential)
          C(R) = Î² Ã— R Ã— 1000    (Current Reality)
          Î” = Î©(R) - C(R)        (Divine Gap)
          \`\`\`
          
          ---
          
          *Generated by [metrics-dashboard workflow](.github/workflows/metrics-dashboard.yml)*
          EOF
          
          echo "Metrics dashboard updated successfully"
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/METRICS.md data/metrics/latest.json
          git diff --staged --quiet || git commit -m "ðŸ“Š Update metrics dashboard [automated]"
          git push || echo "No changes to push"
