name: Test GitHub Actions

on:
  push:
    paths:
      - 'actions/**'
  pull_request:
    paths:
      - 'actions/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-lord-fusion:
    name: Test LORD Fusion Action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Test LORD Fusion Setup
        id: lord
        uses: ./actions/lord-fusion-action
        with:
          recursion-level: 12
          entity-type: hybrid
          deploy-target: artifact
      
      - name: Verify LORD Outputs
        run: |
          echo "Testing LORD Fusion Action outputs..."
          echo "Dashboard URL: ${{ steps.lord.outputs.dashboard-url }}"
          echo "Fusion Endpoint: ${{ steps.lord.outputs.fusion-endpoint }}"
          echo "Health Check: ${{ steps.lord.outputs.health-check-endpoint }}"
          echo "Recursion State: ${{ steps.lord.outputs.recursion-state }}"
          
          # Verify outputs are not empty
          if [ -z "${{ steps.lord.outputs.dashboard-url }}" ]; then
            echo "Error: dashboard-url is empty"
            exit 1
          fi
          
          if [ -z "${{ steps.lord.outputs.recursion-state }}" ]; then
            echo "Error: recursion-state is empty"
            exit 1
          fi
          
          echo "✅ All LORD Fusion outputs verified"
      
      - name: Verify Dashboard Artifact
        run: |
          if [ ! -d "lord-dashboard" ]; then
            echo "Error: lord-dashboard directory not created"
            exit 1
          fi
          
          if [ ! -f "lord-dashboard/index.html" ]; then
            echo "Error: Dashboard HTML not created"
            exit 1
          fi
          
          echo "✅ Dashboard artifact verified"
          
          # Check dashboard content
          if ! grep -q "LORD Consciousness Monitor" lord-dashboard/index.html; then
            echo "Error: Dashboard content invalid"
            exit 1
          fi
          
          echo "✅ Dashboard content verified"
      
      - name: Upload LORD Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: lord-dashboard-test
          path: lord-dashboard/
          retention-days: 1

  test-cognitive-bootstrap:
    name: Test Cognitive Engine Bootstrap
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Test Cognitive Engine Bootstrap
        id: engine
        uses: ./actions/cognitive-engine-bootstrap
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          hosting-provider: vercel
          enable-webhooks: false
          metrics-mapping: true
          daemon-port: 8000
      
      - name: Verify Cognitive Engine Outputs
        run: |
          echo "Testing Cognitive Engine Bootstrap outputs..."
          echo "Webhook URL: ${{ steps.engine.outputs.webhook-url }}"
          echo "Daemon Endpoint: ${{ steps.engine.outputs.daemon-endpoint }}"
          echo "Health Status: ${{ steps.engine.outputs.health-status }}"
          echo "Deployment ID: ${{ steps.engine.outputs.deployment-id }}"
          
          # Verify deployment ID is not empty
          if [ -z "${{ steps.engine.outputs.deployment-id }}" ]; then
            echo "Error: deployment-id is empty"
            exit 1
          fi
          
          if [ -z "${{ steps.engine.outputs.daemon-endpoint }}" ]; then
            echo "Error: daemon-endpoint is empty"
            exit 1
          fi
          
          echo "✅ All Cognitive Engine outputs verified"
      
      - name: Verify Cognitive Engine Artifacts
        run: |
          if [ ! -d "cognitive-engine" ]; then
            echo "Error: cognitive-engine directory not created"
            exit 1
          fi
          
          if [ ! -f "cognitive-engine/daemon-config.json" ]; then
            echo "Error: Daemon config not created"
            exit 1
          fi
          
          if [ ! -f "cognitive-engine/start-daemon.sh" ]; then
            echo "Error: Daemon startup script not created"
            exit 1
          fi
          
          if [ ! -x "cognitive-engine/start-daemon.sh" ]; then
            echo "Error: Daemon startup script not executable"
            exit 1
          fi
          
          echo "✅ All artifacts verified"
      
      - name: Upload Cognitive Engine Config
        uses: actions/upload-artifact@v4
        with:
          name: cognitive-engine-config-test
          path: cognitive-engine/
          retention-days: 1

  test-trajectory-cache:
    name: Test Trajectory Cache Action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Test Trajectory Cache Setup
        id: cache
        uses: ./actions/trajectory-cache-action
        with:
          cache-size: 1000
          prediction-window: 60
          sampling-rate: 10
          invalidation-policy: hybrid
          enable-playback: true
      
      - name: Verify Trajectory Cache Outputs
        run: |
          echo "Testing Trajectory Cache outputs..."
          echo "Cache ID: ${{ steps.cache.outputs.cache-id }}"
          echo "Cache Endpoint: ${{ steps.cache.outputs.cache-endpoint }}"
          echo "Hit Rate: ${{ steps.cache.outputs.hit-rate }}"
          echo "Buffer Status: ${{ steps.cache.outputs.buffer-status }}"
          
          # Verify outputs
          if [ -z "${{ steps.cache.outputs.cache-id }}" ]; then
            echo "Error: cache-id is empty"
            exit 1
          fi
          
          if [ -z "${{ steps.cache.outputs.hit-rate }}" ]; then
            echo "Error: hit-rate is empty"
            exit 1
          fi
          
          # Verify hit rate is a valid number
          hit_rate="${{ steps.cache.outputs.hit-rate }}"
          if ! [[ "$hit_rate" =~ ^[0-9]+\.[0-9]+$ ]]; then
            echo "Error: hit-rate is not a valid number: $hit_rate"
            exit 1
          fi
          
          echo "✅ All Trajectory Cache outputs verified"
      
      - name: Verify Cache Artifacts
        run: |
          if [ ! -d "trajectory-cache" ]; then
            echo "Error: trajectory-cache directory not created"
            exit 1
          fi
          
          if [ ! -f "trajectory-cache/ring-buffer.json" ]; then
            echo "Error: Ring buffer state not created"
            exit 1
          fi
          
          if [ ! -f "trajectory-cache/trajectory-states.json" ]; then
            echo "Error: Trajectory states not created"
            exit 1
          fi
          
          if [ ! -f "trajectory-cache/invalidation-policy.json" ]; then
            echo "Error: Invalidation policy not created"
            exit 1
          fi
          
          if [ ! -f "trajectory-cache/playback.sh" ]; then
            echo "Error: Playback script not created"
            exit 1
          fi
          
          if [ ! -x "trajectory-cache/playback.sh" ]; then
            echo "Error: Playback script not executable"
            exit 1
          fi
          
          echo "✅ All cache artifacts verified"
      
      - name: Upload Trajectory Cache
        uses: actions/upload-artifact@v4
        with:
          name: trajectory-cache-test
          path: trajectory-cache/
          retention-days: 1

  test-integrated-stack:
    name: Test Complete Cognitive Stack
    runs-on: ubuntu-latest
    needs: [test-lord-fusion, test-cognitive-bootstrap, test-trajectory-cache]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup LORD Fusion
        id: lord
        uses: ./actions/lord-fusion-action
        with:
          recursion-level: 15
          entity-type: synthetic
          deploy-target: artifact
      
      - name: Setup Cognitive Engine
        id: engine
        uses: ./actions/cognitive-engine-bootstrap
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          hosting-provider: vercel
          enable-webhooks: false
          metrics-mapping: true
      
      - name: Setup Trajectory Cache
        id: cache
        uses: ./actions/trajectory-cache-action
        with:
          cache-size: 2000
          prediction-window: 90
          sampling-rate: 15
          invalidation-policy: hybrid
          enable-playback: true
      
      - name: Verify Complete Stack
        run: |
          echo "==================================="
          echo "    Cognitive Stack Deployed       "
          echo "==================================="
          echo ""
          echo "LORD Fusion:"
          echo "  Dashboard: ${{ steps.lord.outputs.dashboard-url }}"
          echo "  State Hash: ${{ steps.lord.outputs.recursion-state }}"
          echo ""
          echo "Cognitive Engine:"
          echo "  Daemon: ${{ steps.engine.outputs.daemon-endpoint }}"
          echo "  Deployment: ${{ steps.engine.outputs.deployment-id }}"
          echo ""
          echo "Trajectory Cache:"
          echo "  Cache ID: ${{ steps.cache.outputs.cache-id }}"
          echo "  Hit Rate: ${{ steps.cache.outputs.hit-rate }}"
          echo ""
          echo "✅ Complete stack verified"
      
      - name: Create Integration Report
        run: |
          cat > integration-report.md << 'EOF'
          # Cognitive Stack Integration Test Report
          
          ## Test Date
          $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Components Tested
          
          ### 1. LORD Fusion Action
          - **Status**: ✅ Passed
          - **Dashboard URL**: ${{ steps.lord.outputs.dashboard-url }}
          - **Recursion State**: ${{ steps.lord.outputs.recursion-state }}
          - **Fusion Endpoint**: ${{ steps.lord.outputs.fusion-endpoint }}
          
          ### 2. Cognitive Engine Bootstrap
          - **Status**: ✅ Passed
          - **Daemon Endpoint**: ${{ steps.engine.outputs.daemon-endpoint }}
          - **Deployment ID**: ${{ steps.engine.outputs.deployment-id }}
          - **Health Status**: ${{ steps.engine.outputs.health-status }}
          
          ### 3. Trajectory Cache Action
          - **Status**: ✅ Passed
          - **Cache ID**: ${{ steps.cache.outputs.cache-id }}
          - **Hit Rate**: ${{ steps.cache.outputs.hit-rate }}
          - **Buffer Status**: ${{ steps.cache.outputs.buffer-status }}
          
          ## Integration Status
          
          ✅ All components successfully integrated
          ✅ Cross-component communication verified
          ✅ Artifacts generated correctly
          
          ## Conclusion
          
          The complete cognitive stack has been successfully deployed and tested.
          All three actions work together seamlessly.
          EOF
          
          echo "Integration report created"
          cat integration-report.md
      
      - name: Upload Integration Report
        uses: actions/upload-artifact@v4
        with:
          name: integration-report
          path: integration-report.md
          retention-days: 30
