# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  build-and-test:
    # Specify the execution environment. You can specify an image from Docker Hub or use one of our convenience images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/guides/execution-managed/executor-intro/ & https://circleci.com/docs/reference/configuration-reference/#executor-job
    docker:
      # Use stable tag for reproducible builds
      # See: https://circleci.com/developer/images/image/cimg/base
      - image: cimg/base:stable

    # Add steps to the job
    # See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#steps-overview & https://circleci.com/docs/reference/configuration-reference/#steps
    steps:
      # Checkout the code as the first step.
      - checkout
      - run:
          name: Install Node.js dependencies
          command: |
            if [ -f package.json ]; then
              echo "Detected package.json, installing Node.js dependencies with npm ci..."
              npm ci
            else
              echo "No package.json found, skipping Node.js dependency installation."
            fi
      - run:
          name: Build and test Node.js project
          command: |
            if [ -f package.json ]; then
              echo "Running npm run build..."
              npm run build --if-present
              echo "Running npm test..."
              npm test --if-present
            else
              echo "No package.json found, skipping Node.js build and tests."
            fi
      - run:
          name: Install Python dependencies
          command: |
            if [ -f requirements.txt ]; then
              echo "Detected requirements.txt, installing Python dependencies with pip..."
              python -m pip install --upgrade pip
              python -m pip install -r requirements.txt
            else
              echo "No requirements.txt found, skipping Python dependency installation."
            fi
      - run:
          name: Run pytest
          command: |
            if command -v pytest >/dev/null 2>&1; then
              echo "Running pytest..."
              pytest
            else
              echo "pytest is not installed or not on PATH; skipping Python tests."
            fi

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  build-and-test-workflow:
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build-and-test